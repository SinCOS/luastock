<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{title}}</title>
    <link rel="shortcut icon" href="../favicon.ico">
    <link rel="stylesheet" href="../public/layui/css/layui.css" />
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.15/css/dataTables.bootstrap.min.css">

</head>

<style type="text/css">
    .layui-nav {
        margin-left: 0px;
    }

    .header {
        height: 60px;
        border-bottom: none;
    }

    .layui-nav-right {
        position: absolute;
        right: 0px;
        top: 0;
    }

    .tb_body {
        padding-left: 5px;
    }
</style>

<body>
    <div class="layui-layout layui-layout-admin" id='app'>
        {(view/menu.html)}
        <div class="layui-body tb_body" style="overflow-y:scroll;">
            <div class="layui-tab layui-tab-card">
                <ul class="layui-tab-title">
                    <li class="layui-this">净流入</li>
                    <li class="">分时DDX</li>
                    <li class="">逆势主力资金流</li>
                </ul>
                <div class="layui-tab-content" style="height:auto;">
                    <div class="layui-tab-item layui-show">
                        <jlrdatables v-bind:parent_url="reflush_url"></jlrdatables>
                    </div>
                    <div class="layui-tab-item">
                        <ddxdatatables v-bind:parent_url="reflush_url" ></ddxdatatables>
                    </div>
                    <div class="layui-tab-item">
                        <nszldatatables v-bind:parent_url="reflush_url"></nszldatatables>
                    </div>
                </div>
            </div>

        </div>

        <div class="layui-footer">
            copyright @ ssin
        </div>
        {(view/public_div.html)}
    </div>

</body>
<script type="text/x-template" id='datables'>
    <table v-bind:id="id" class="table table-striped table-bordered" cellspacing="0" width="100%">
        <thead>
            <tr>
                <th rowspan="2" colspan="3">说明:委托20万以上，成交的金额算做主力流入流出资金</th>
                <th colspan="2">实时累计（万元）</th>
                <th colspan="3">1分钟</th>
                <th>3分钟</th>
                <th> </th>
                <th></th>
            </tr>
            <tr>
                <th colspan="2">15：00-9：30</th>
                <th v-text="time.last_one"></th>
                <th v-text="time.last_two"></th>
                <th v-text="time.last_three"></th>
                <th>9：32-9：30</th>
                <th> </th>
                <th></th>
                <th></th>
            </tr>
            <tr>
                <th style="width: 50px;">排名</th>
                <th style="width: 70px;">股票代码</th>
                <th style="width: 70px;">股票名称</th>
                <th style="width: 70px;" id="tab1">流入占比</th>
                <th style="width: 70px;" id="tab2">总净流入</th>
                <th style="width: 70px;" id="tab3">净流入</th>
                <th style="width: 70px;">净流入</th>
                <th style="width: 70px;">净流入</th>
                <th style="width: 70px;" id="tab4">净流入</th>
                <th style="width: 20px;">涨幅</th>
                <th style="width: 20px;">涨速</th>
                <th style="width: 30px;">操作</th>
            </tr>
        </thead>
    </table>
</script>
<script type="text/x-template" id='ddxtemplate'>
    <table v-bind:id="id" class="table table-striped table-bordered" cellspacing="0" width="100%">
        <thead>
            <tr>
                <th rowspan="2" colspan="3">说明:委托20万以上，成交的金额算做主力流入流出资金</th>
                <th colspan='2'>实时累计（万元）</th>
                <th colspan="3">1分钟</th>
                <th>3分钟</th>
                <th> </th>

            </tr>
            <tr>
                <th colspan='2'>15：00-9：30</th>
                <th v-text="time.last_one"></th>
                <th v-text="time.last_two"></th>
                <th v-text="time.last_three"></th>
                <th v-text="time.last_one + '-' + time.last_three"></th>
                <th> </th>
                <th></th>
                <th></th>
            </tr>
            <tr>
                <th>排名</th>
                <th>股票代码</th>
                <th>股票名称</th>
                <th>流入占比 %</th>
                <th>总DDX</th>
                <th>DDX</th>
                <th>DDX</th>
                <th>DDX</th>
                <th>DDX</th>
                <th>涨幅</th>
                <th>涨速</th>
                <th>操作</th>
            </tr>
        </thead>
    </table>
</script>
<script type="text/x-template" id='nszltemplate'>
    <table v-bind:id="id" class="table table-striped table-bordered" cellspacing="0" width="100%">
        <thead>

            <tr>
                <th colspan="12">逆市主力资金流</th>
            </tr>
            <tr>
                <th colspan="12">说明:委托20万以上，成交的金额算做主力流入流出资金</th>
            </tr>

            <tr>
                <th style="width: 10px;">排名</th>
                <th style="width: 80px;">股票代码</th>
                <th style="width: 100px;">股票名称</th>
                <th style="width: 130px;">大盘下跌时买入累计（万元)</th>
                <th style="width: 130px;">大盘上涨时卖出累计（万元)</th>
                <th style="width: 130px;">逆市主力资金净流向（万元）</th>
                <th style="width: 130px;">进货次数(240/x)</th>
                <th style="width: 130px;">出货次数(240/x)</th>
                <th style="width: 130px;" id="tab4">进出差值(240/x)</th>
                <th style="width: 60px;">涨幅</th>
                <th style="width: 60px;">涨速</th>
                <th style="width: 60px;">操作</th>
            </tr>
        </thead>
    </table>
</script>
<script src="https://unpkg.com/vue/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/vue.resource/1.2.1/vue-resource.min.js"></script>
<script src="../public/layui/layui.js" charset="utf-8"></script>
<script type="text/javascript" src="https://cdn.datatables.net/r/bs-3.3.5/jqc-1.11.3,dt-1.10.8/datatables.min.js"></script>
<script type="text/javascript">
    function jsk(aoData) {
        var u = {}
        u = aoData[0]

        //alert(u.dtaw)
        var arr = {},
            b = {},
            c = {}
        for (i = 0; i < aoData.length; i++) {
            //k=JSON.stringify(aoData[i].name)
            k = aoData[i].name
            if (typeof arr[k] == 'object') {
                b = JSON.stringify(arr[k])
                c = JSON.stringify(b.data)
                alert(b)
            } else {
                arr[k] = aoData[i].value
            }
        }
        return arr
    }


    function build_datables(table) {
        var Language = { // 汉化
            "sProcessing": "正在加载数据...",
            "sLengthMenu": "显示_MENU_条 ",
            "sZeroRecords": "没有您要搜索的内容",
            "sInfo": "从_START_ 到 _END_ 条记录——总记录数为 _TOTAL_ 条",
            "sInfoEmpty": "记录数为0",
            "sInfoFiltered": "(全部记录数 _MAX_  条)",
            "sInfoPostFix": "",
            "sSearch": "搜索",
            "sUrl": "",
            "oPaginate": {
                "sFirst": "第一页",
                "sPrevious": " 上一页 ",
                "sNext": " 下一页 ",
                "sLast": " 最后一页 "
            }
        };
        var datables_params = {
            "aaSorting": [
                [8, "desc"]
            ],
            "oLanguage": Language,

            "processing": true, //载入数据的时候是否显示“载入中”
            "serverSide": true, //生成get数据
            "columns": table.columns,
            "fnServerData": function (sSource, aoData, fnCallback) {
                console.log(table.stock_url);
                console.log('666');
                $.ajax({
                        url: table.stock_url,
                        type: 'GET',
                        dataType: 'json',
                        data: jsk(aoData),
                    })
                    .done(function (resp) {
                        fnCallback(resp);
                    })
                    .fail(function (resp) {
                        var json = resp.responseJSON;
                        if (json.status == 404) {
                            login();
                        } else if (json.status == 403) {
                            layer.msg(json.message);
                        }

                    })
                    .always(function () {
                        console.log("complete");
                    });


            },
            "fnRowCallback": function (nRow, aData, iDisplayIndex) {
                var page = table.current.page();
                var page_len = table.current.page.len();
                $('td:eq(0)', nRow).text(page * page_len + iDisplayIndex + 1);
                var $object = null;;

                $object = $('td:eq(11)', nRow);

                $object.addClass('cpy_id').attr('data', aData['cpy_id']).on('click', function () {
                    var self = this;
                    var cpy_id = $(this).attr('data');
                    var cpy_name = $(this).attr("cpy_name");
                    var _title = $(self).text();
                    if (_title == '取消关注') {
                        Vue.http.delete('/user/favor/' + app.$data.favorselectIndex + '/' + cpy_id).then(
                            function ($resp) {
                                layer.msg($resp.body.message)
                                if ($resp.body.status == 200) {
                                    setTimeout(function () {
                                        table.current.ajax.reload();
                                    }, 2000);
                                }
                            }).catch(function ($resp) {
                            alert("删除失败");
                        });

                        return false;
                    }
                    if (!app.$data.loginIn) {
                        login();
                        return false;
                    }
                    var layer_index = layer.open({
                        type: 1,
                        title: '自选股收藏夹',
                        content: $("#favor"),
                        area: ['345px', '435px'],
                        btn: ['新建', '确认'],
                        yes: function (index, layero) {
                            layer.prompt({
                                title: '新建收藏夹'
                            }, function (value, iindex, elem) {
                                if (!value || value == '') {


                                    return false;
                                }
                                Vue.http.post('/user/category', {
                                    name: value
                                }, {
                                    headers: {
                                        "Content-type": "application/x-www-form-urlencoded"
                                    }
                                }).then(function (resp) {
                                    if (resp.body.status == 400) {
                                        layer.msg(resp.body.message);
                                        setTimeout(function () {
                                            login();
                                        }, 3000);

                                    } else if (resp.body.status == 200) {
                                        app.reflushFavor();

                                    }

                                }, function (resp) {
                                    layer.msg('网络连接失败!!!');
                                });

                                layer.close(iindex);
                            });

                        },
                        btn2: function () {
                            if (app.save_favor(cpy_id)) {
                                return true;
                            }

                        }
                    });
                    return false;
                }).attr('cpy_name', aData['name']).html(app.$data.favorClickIndex ?
                    '<a href="javascipt:void;">取消关注</a>' : '<a href="javascipt:void;">关注</a>').css({
                    "cursor": 'pointer'
                });;
                if (parseFloat(aData['zf']) > 0) {
                    $('td:eq(9)', nRow).addClass('error');
                    aData['zf'] = '+' + aData['zf'];
                    $('td:eq(9)', nRow).text(aData['zf'])
                    console.log(aData['zf']);
                } else if (parseFloat(aData['zf']) < 0) {
                    $('td:eq(9)', nRow).addClass('success');
                }
                return nRow;
            }
        };
        return datables_params;
    }
</script>
<script type="text/javascript" src="../public/js/common.js?v2.10"></script>
<script type="text/javascript" src="../public/js/table.js?v1"></script>
<style type="text/css">
    td.error {
        background-color: #f04124;
        border-color: #de2d0f;
        color: #fff;
    }

    td.success {
        background-color: #56A73D;
        border-color: #3a945b;
        color: #fff;
    }
</style>
{(view/footer.html)}

</html>